library(dplyr)
library(leaflet)
library(sf)
library(RColorBrewer)
library(ggplot2)

server <- function(input, output, session) {
  
  # subset data to SVI category selection
  updatedata <- reactive({
    geo_data[c("geoid", "namelsad", input$theme)] %>%
      `colnames<-`(c("geoid", "namelsad", "theme", "geometry")) %>%
      sf::st_transform('+proj=longlat +datum=WGS84') %>%
      cbind(as.data.frame(st_coordinates(.)) %>% distinct(L3, .keep_all = T))
  })
  
  # create map
  output$map <- renderLeaflet(
    leaflet() %>%
      addProviderTiles("CartoDB.Positron") %>%
      setView(lng = -95.39, lat = 29.8, zoom = 9.5)
    
  )
  
  # returns census tracts that are in bounds on screen
  tracts_view <- reactive({
    
    df <- updatedata()
    
    if (is.null(input$map_bounds))
      return(df[FALSE,])
    bounds <- input$map_bounds
    latRng <- range(bounds$north, bounds$south)
    lngRng <- range(bounds$east, bounds$west)
    
    subset(df,
           Y >= latRng[1] & Y <= latRng[2] &
             X >= lngRng[1] & X <= lngRng[2])
    
  })
  
  # plot histogram with SVI score distribution
  output$histPlot <- renderPlot({
    
    if (nrow(tracts_view()) == 0)
      return(NULL)
    
    hist(tracts_view()$theme,
         main = "SVI distribution for visible tracts",
         xlab = "Percentile",
         ylab = NULL,
         xlim = range(0,1),
         col = '#666666',
         border = 'white')
    
  })
  
  # update map with new selections
  observe({
    
    df <- updatedata()
    
    pal <- colorNumeric(palette = pal_cols[[input$theme]], domain = df$theme, na.color = "#d1d1d1")
    popup <- paste0(df$namelsad, "<br>", df$theme)
    
    leafletProxy("map", data = df) %>%
      clearShapes() %>%
      clearControls() %>%
      addPolygons(color = ~pal(theme),
                  opacity = .2,
                  fillOpacity = 0.6,
                  weight = 0.9,
                  smoothFactor = 0.3,
                  popup = popup,
                  highlightOptions = highlightOptions(color = "#fff", 
                                                      weight = 2,
                                                      opacity = .6,
                                                      bringToFront = TRUE)) %>%
      addLegend("bottomright",
                pal = pal,
                values = ~theme,
                title = "Percentile rank",
                #bins = c(0, .2, .4, .6, .8, 1),
                opacity = 0.8)
  })
  
}
