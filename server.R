library(tidyr)
library(tigris)
library(sf)
library(RColorBrewer)
library(ggplot2)

server <- function(input, output, session) {
  
  # subset data to SVI category selection
  update_data <- reactive({
    geo_data[c("geoid", "name", "e_totpop", "perc_pov", "countyfp", input$theme)] %>%
      filter(countyfp == input$county) %>%
      `colnames<-`(c("geoid", "tract", "pop", "perc_pov", "county", "theme", "geometry")) %>%
      sf::st_transform('+proj=longlat +datum=WGS84') %>%
      cbind(as.data.frame(st_coordinates(.)) %>% distinct(L3, .keep_all = T))
  })
  
  # returns census tracts that are in bounds on screen
  tracts_view <- reactive({
    
    df <- update_data() 
    df <- svi_perc_to_cat(df)
    
    if (is.null(input$map_bounds))
      return(df[FALSE,])
    
    bounds <- input$map_bounds
    latRng <- range(bounds$north, bounds$south)
    lngRng <- range(bounds$east, bounds$west)
    
    subset(df, Y >= latRng[1] & Y <= latRng[2] & 
             X >= lngRng[1] & X <= lngRng[2])
    
  })
  
  # plot bar chart for SVI scores
  output$barPlot <- renderPlot({
    
    if (input$barPlot) {
      
      if (nrow(tracts_view()) == 0)
        return(NULL)
      
      df <- tracts_view()
      
      ggplot(df, aes(x = cat, y = ..count../sum(..count..)*100, fill = cat)) +
        geom_bar() +
        scale_fill_brewer(palette = pal_cols[[input$theme]]) +
        scale_x_discrete(limits = svi_labs, 
                         labels = svi_labs) +
        labs(title = "Social vulnerability for visible tracts",
             x = NULL,
             y = "Percentage of tracts",
             fill = NULL) +
        theme_minimal() +
        theme(legend.position = "none")
    }
    
  })
  
  # create map
  output$map <- renderLeaflet(
    
    leaflet() %>%
      addProviderTiles("CartoDB.Positron") 
    
  )
  
  # update map with new selections
  observe({
    
    df <- update_data()
    coords <- bbox_coords %>% 
      filter(countyfp == input$county)
    
    pal <- colorNumeric(palette = pal_cols[[input$theme]], domain = df$theme, na.color = "#d1d1d1")
    popup <- paste0("<b>Tract: </b>", df$tract, "<br>", 
                    "<b>Population: </b>", df$pop, "<br>",
                    "<b>% poverty: </b>", df$perc_pov, "%", "<br>",
                    "<b>SVI percentile: </b>", df$theme)
    
    proxy <- leafletProxy("map", data = df) %>%
      fitBounds(lng1 = coords$xmax, lat1 = coords$ymax, lng2 = coords$xmin,  lat2 = coords$ymin) %>%
      clearShapes() %>%
      clearControls() %>%
      addPolygons(color = ~pal(theme),
                  opacity = .2,
                  fillOpacity = 0.6,
                  weight = 0.9,
                  smoothFactor = 0.3,
                  popup = popup,
                  highlightOptions = highlightOptions(color = "#fff", 
                                                      weight = 2,
                                                      opacity = .6,
                                                      bringToFront = TRUE)) 
    if (input$legend) {
      proxy %>% addLegend("bottomright",
                          pal = pal,
                          values = ~theme[!is.na(theme)],
                          title = "Percentile rank",
                          opacity = 0.8) 
    }
    
  })
  
}
