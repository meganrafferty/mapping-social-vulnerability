# data management steps for SVI 
dm_svi_data <- function(df) {
  
  svi_vars <- c("rpl_theme1", "rpl_theme2", "rpl_theme3", "rpl_theme4", "rpl_themes")
  
  df <- df %>%
    rename_all(tolower) %>%
    mutate(fips = as.character(fips),
           perc_pov = round(e_pov150/e_totpop*100, 1)) %>%
    filter_at(svi_vars, all_vars(. >= 0)) %>%
    mutate(across(svi_vars, ~round(.x, digits = 2))) 
  
}

# read in data
get_svi_data <- function() {
  
  options(tigris_use_cache = TRUE)
  
  svi_data <- read.csv("./data/svi_tx_2020.csv") %>% dm_svi_data()
  shp_file <- tigris::tracts(state = "48", year = "2020", cb = T) 
  
  df <- shp_file %>%
    rename_all(tolower) %>%
    mutate(countyfp = as.integer(countyfp)) %>%
    left_join(svi_data, by = c("geoid" = "fips")) 
  
  return(df)
  
}


# mutate SVI percentiles to categories
svi_perc_to_cat <- function(df) {
  
  df <- df %>%
    mutate(cat = case_when(
      theme < 0.25 ~ "Low",
      theme >= 0.25 & theme < 0.5 ~ "Medium low",
      theme >= 0.5 & theme < 0.75 ~ "Medium high",
      theme >= 0.75 ~ "High",
      T ~ NA_character_
    )) 
  
  df$cat <- factor(df$cat, levels = svi_labs,
                   labels = svi_labs)
  
  return(df)
}


# # get bounding box coordinates
# create_bbox_df <- function(shp_df) {
#   
#   bbox_coords <- shp_df %>%
#     group_by(geoid) %>%
#     mutate(bbox = list(st_bbox(geometry))) %>%
#     tidyr::unnest_wider(bbox) %>%
#     st_drop_geometry() %>%
#     ungroup() %>%
#     select(countyfp, xmin:ymax, -name) %>%
#     group_by(countyfp) %>%
#     summarise(xmax = max(xmax), xmin = min(xmin), ymax = max(ymax), ymin = min(ymin))
#   
#   write_csv(bbox_coords, "./data/bbox_coords.csv")
#   
# }
